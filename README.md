# Avito_tech_internship

Сервис для управления пользователями, командами и pull request'ами.  
При создании PR автоматически назначаются ревьюеры из команды автора.

## Стек

- Go 1.25
- PostgreSQL
- Docker, docker-compose
  
## Вопросы и допущения
В рамках решения выполнено следующее упрощение:
Может ли 1 пользователь состоять сразу в 2+ командах? В рамках данной реализации допускается, что команды обособлены, и в команду можно взять лишь свободного пользователя. Т.е. 1 пользователь на 1 команду.

## Основная логика

- При создании PR:
  - Определяется команда автора PR.
  - Из этой команды выбираются все активные пользователи, кроме автора.
  - Случайным образом выбираются до двух ревьюеров.
- При переназначении ревьюера:
  - Нельзя изменять ревьюеров у PR со статусом 'MERGED'.
  - Новый ревьюер выбирается случайным образом из активных пользователей команды заменяемого ревьюера.
- Операция merge:
  - Переводит PR в статус 'MERGED'.

## Основная доменная логика

### Команды

- '/team/add'
  - Создаёт новую команду с участниками.
  - Если команда уже существует ('team_name' тот же) — возвращает ошибку 'TEAM_EXISTS'.
  - Пользователи из 'members' создаются или обновляются (upsert) и привязываются к этой команде.
- '/team/get'
  - Возвращает команду и всех её участников по 'team_name'.

### Пользователи

- '/users/setIsActive'
  - Обновляет флаг активности пользователя 'is_active'.
  - Если пользователь не найден — 'NOT_FOUND'.
- '/users/getReview'
  - Возвращает список PR'ов, где пользователь назначен ревьювером.
  - Даже если PR'ов нет, возвращается '200 OK' с пустым массивом 'pull_requests'.

### Pull Request'ы

- '/pullRequest/create'
  - Создаёт PR:
    - задаётся 'pull_request_id', 'pull_request_name', 'author_id';
    - определяется команда автора;
    - из активных пользователей команды (кроме автора) выбираются кандидаты;
    - случайным образом выбираются до **двух** ревьюеров.
  - Если PR с таким 'pull_request_id' уже существует → '409 PR_EXISTS'.
  - Если автор не найден → '404 NOT_FOUND'.
  - Если автор не активен → '409' (доменная ошибка).

- '/pullRequest/merge'
  - Помечает PR как 'MERGED' (идемпотентно).
  - При первом успешном merge устанавливается 'mergedAt'.
  - Повторный merge возвращает тот же PR без ошибок.
  - Если PR не найден → '404 NOT_FOUND'.

- '/pullRequest/reassign'
  - Переназначает конкретного ревьювера на другого из его команды.
  - **Ограничения:**
    - Нельзя менять ревьюеров у уже 'MERGED' PR → '409 PR_MERGED'.
    - Если указанный пользователь не был ревьювером этого PR → '409 NOT_ASSIGNED'.
    - Новый ревьювер выбирается случайным образом из активных участников команды:
      - исключаются автор PR;
      - исключаются текущие ревьюверы;
      - исключается заменяемый ревьювер.
    - Если подходящих кандидатов нет → '409 NO_CANDIDATE'.

## Линтер и статический анализ

Для статического анализа кода используется ['golangci-lint'](https://golangci-lint.run/).

В репозитории лежит конфигурация '.golangci.yml', включающая основные линтеры:

- 'govet', 'staticcheck' — поиск потенциальных багов;
- 'errcheck' — проверка, что ошибки не игнорируются;
- 'gofmt', 'goimports' — форматирование и импорты;
- 'gosimple', 'ineffassign', 'revive' — упрощение и приведение кода к best practices.

## Запуск вручную

Запуск проекта
go build ./cmd/app
docker compose up --build

Остановка проекта

docker compose down
флаг -v для очистки базы

## Работа с Makefile
Доступные команды:

- 'make build'
Локальная сборка
- 'make up'
Поднимает весь проект (PostgreSQL + приложение) через Docker
- 'make down'
Останавливает контейнеры
- 'make logs'
Просмотр логов приложения в docker compose
- 'make seed'
ВАЖНО! Команда рассчитана на чистую БД и используется только для первого тестирования
Создание 83 пользователей для теста
- 'make load-test'
Проведение теста
- 'make lint'
Поиск "неприятного" для разработчиков в коде
На данный момент 
golangci-lint run ./...
0 issues.
## Нагрузочное тестирование

Тестирование и разработка выполнялись на Windows 10 с использованием Docker Desktop. 
Сервис и PostgreSQL запускаются в контейнерах, поэтому перенос на Linux (docker compose up) не требует изменений кода.

Для проверки нефункциональных требований был реализован простой нагрузочный сценарий:

- Утилита 'cmd/seed' создаёт 15 команд и 83 пользователей через HTTP ('/team/add').
- Утилита 'cmd/loadtest' генерирует поток запросов:
  - для случайного автора (из существующих пользователей) создаётся PR ('/pullRequest/create');
  - далее этот PR сразу же мёржится ('/pullRequest/merge');
  - доменные конфликты (например, автор неактивен) считаются ожидаемым поведением и не относятся к техническим ошибкам.

Пример ручного запуска(без make, с параметрами):

# сидирование данных
Команда выполняется только 1 раз, если БД пустая (создаёт 15 команд и 83 пользователя, для которых дальше идут тесты)
go run ./cmd/seed

# нагрузочный тест: ~5 RPS, 50 секунд
go run ./cmd/loadtest -duration=50s -rps=5