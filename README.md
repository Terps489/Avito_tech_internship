# Avito_tech_internship

Сервис для управления пользователями, командами и pull request'ами.  
При создании PR автоматически назначаются ревьюеры из команды автора.

---

## Стек технологий

- **Go 1.25**
- **PostgreSQL**
- **Docker / docker-compose**
- **golangci-lint**
- **Makefile**

---
  
# 1 Поддержка разных ОС (Windows / Linux)

В ТЗ не указано, для какой ОС должен собираться сервис.  
Проект разработан и проверен на двух окружениях:

- **Windows 10 (Docker Desktop)**
- **Ubuntu 22.04 (native)**

Поскольку сервис и база запускаются в Docker-контейнерах,  
код полностью переносим между ОС без изменений.

Для удобства:

- Makefile автоматически определяет ОС ('uname -s')  
  и запускает корректный пост-тестовый скрипт:
  - PowerShell ('check_after_load_win.ps1') — для Windows
  - Bash ('check_after_load.sh') — для Linux
  
# 2 Комментарии в коде

ТЗ не указывает язык комментариев.  
Выбран английский, потому что:

- в некоторых терминалах/средах кириллица отображается некорректно;
- английские комментарии совместимы со всеми CI/CD, IDE и линтерами;
- проект содержит собственную полноценную документацию (OpenAPI + README), поэтому комментарии сведены к минимуму.

---

## Основная логика

- При создании PR:
  - Определяется команда автора PR.
  - Из этой команды выбираются все активные пользователи, кроме автора.
  - Случайным образом выбираются до двух ревьюеров.
- При переназначении ревьюера:
  - Нельзя изменять ревьюеров у PR со статусом 'MERGED'.
  - Новый ревьюер выбирается случайным образом из активных пользователей команды заменяемого ревьюера.
- Операция merge:
  - Переводит PR в статус 'MERGED'.

## Основная доменная логика

### Команды

#### 'POST /team/add'
- Создаёт новую команду.
- Если команда существует → 'TEAM_EXISTS'.
- Пользователи создаются/обновляются (upsert) и привязываются к команде.
- Один пользователь может состоять **только в одной команде** (допущение).

#### 'GET /team/get?team_name=<name>'
- Возвращает команду и всех участников.
- Если команда не найдена → 'NOT_FOUND'.

---

### Пользователи

#### 'POST /users/setIsActive'
- Обновляет флаг активности.
- Неактивные пользователи **не назначаются** ревьюверами.
- Пользователь не найден → 'NOT_FOUND'.

#### 'GET /users/getReview?user_id=<id>'
- Возвращает PR, где пользователь — ревьювер.
- Если PR нет — возвращается '200 OK' с пустым списком.

---

### Pull Requests

#### 'POST /pullRequest/create'
- Создаёт PR.
- Определяет команду автора.
- Выбирает до **двух** активных ревьюверов.
- Автор не найден → 'NOT_FOUND'.
- PR существует → 'PR_EXISTS'.

#### 'POST /pullRequest/merge'
- Идемпотентный merge: повторный вызов не вызывает ошибки.
- Первый merge проставляет 'mergedAt'.

#### 'POST /pullRequest/reassign'
- Меняет ревьювера на нового члена команды.
- Ограничения:
  - PR уже merged → 'PR_MERGED'.
  - Старый ревьювер не назначен → 'NOT_ASSIGNED'.
  - Нет доступных кандидатов → 'NO_CANDIDATE'.

---

## Эндпоинт статистики

Добавлен необязательный эндпоинт из “дополнительных заданий”:

### 'GET /stats/assignments'
- Возвращает количество назначений по каждому ревьюверу.
- Используется в тестах и нагрузочных проверках.

---

## Линтер и статический анализ

Для статического анализа кода используется ['golangci-lint'](https://golangci-lint.run/).

В репозитории лежит конфигурация '.golangci.yml', включающая основные линтеры:

- 'govet', 'staticcheck' — поиск потенциальных багов;
- 'errcheck' — проверка, что ошибки не игнорируются;
- 'ineffassign' — упрощение и приведение кода к best practices.
На момент финальной версии:

golangci-lint run ./...
0 issues.

## Запуск вручную

Запуск проекта
go build ./cmd/app
docker compose up --build

Остановка проекта

docker compose down
флаг -v для очистки базы

## Работа с Makefile
Доступные команды:

- 'make build'
Локальная сборка
- 'make up'
Поднимает весь проект (PostgreSQL + приложение) через Docker
- 'make down'
Останавливает контейнеры
- 'make logs'
Просмотр логов приложения в docker compose
- 'make seed'
ВАЖНО! Команда рассчитана на чистую БД и используется только для первого тестирования
Создание 83 пользователей для теста
- 'make load-test'
Проведение теста
- 'make lint'
Поиск "неприятного" для разработчиков в коде
- 'make check'
Глубокий post-load тест (автооценка стабильности)

## Нагрузочное тестирование

Тестирование и разработка выполнялись на Windows 10 с использованием Docker Desktop. 
Сервис и PostgreSQL запускаются в контейнерах, поэтому перенос на Linux (docker compose up) не требует изменений кода.

Для проверки нефункциональных требований был реализован простой нагрузочный сценарий:

- Утилита 'cmd/seed' создаёт 15 команд и 83 пользователей через HTTP ('/team/add').
- Утилита 'cmd/loadtest' генерирует поток запросов:
  - для случайного автора (из существующих пользователей) создаётся PR ('/pullRequest/create');
  - далее этот PR сразу же мёржится ('/pullRequest/merge');
  - доменные конфликты (например, автор неактивен) считаются ожидаемым поведением и не относятся к техническим ошибкам.

Пример ручного запуска(без make, с параметрами):

# Заполнение данных в пустую базу для тестов
Команда выполняется только 1 раз, если БД пустая (создаёт 15 команд и 83 пользователя, для которых дальше идут тесты)
go run ./cmd/seed

# Нагрузочный тест: ~5 RPS, 50 секунд
go run ./cmd/loadtest -duration=50s -rps=5

# Результаты:

Успешно выдержаны серии нагрузочных прогонов:
RPS ~5, 30–50 секунд, 0 технических ошибок, корректные доменные ошибки.

---

# Post-load автоматическая проверка (sanity-check)

После нагрузки можно запустить комплексную проверку стабильности:


Makefile автоматически вызовет нужный скрипт:

| ОС | Скрипт |
|----|--------|
| Windows | 'scripts/check_after_load_win.ps1' |
| Linux   | 'scripts/check_after_load.sh' |

Оба скрипта проверяют:

### ✔ 1. Жив ли сервис — '/health'

### ✔ 2. Корректны ли назначения — '/stats/assignments'

### ✔ 3. Создание и merge 10 дополнительных PR после нагрузки

- проверка идемпотентности merge
- отсутствие доменных ошибок
- правильность назначения ревьюеров

### ✔ 4. '/users/getReview' возвращает корректный список PR

### ✔ 5. Финальный пересчёт статистики

Если всё хорошо:

### Итог

Сервис реализует все функциональные и нефункциональные требования:

- полностью работает через Docker,
- корректно назначает ревьюеров,
- поддерживает merge и reassign,
- проходит нагрузочные тесты,
- проходит вариативные тесты после нагрузочных,
- линтер проходит без ошибок,
- проверено на двух ОС.

Готов к проверке.